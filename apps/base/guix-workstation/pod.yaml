apiVersion: v1
kind: Pod
metadata:
  name: guix-workstation
  annotations:
    # Setting spec.force to true will make Flux recreate the Pod when any
    # immutable field is changed, forcing the Pod to run every time the
    # container image tag changes.
    kustomize.toolkit.fluxcd.io/force: enabled
spec:
  restartPolicy: Never
  automountServiceAccountToken: false
  containers:
  - image: harbor.home.wugi.info/library/guix-image-workstation:latest
    name: guix-workstation
    ports:
    - containerPort: 5353
      name: avahi
      protocol: UDP
    securityContext:
      capabilities:
        add:
        # - CHOWN
        # - DAC_OVERRIDE
        # - DAC_READ_SEARCH
        # - FOWNER
        # - FSETID
        # - KILL
        # - SETGID
        # - SETUID
        # - SETPCAP
        # - LINUX_IMMUTABLE
        # - NET_BIND_SERVICE
        # - NET_BROADCAST
        # - NET_ADMIN
        # - NET_RAW
        # - IPC_LOCK
        # - IPC_OWNER
        # - SYS_MODULE
        # - SYS_RAWIO
        # - SYS_CHROOT
        # - SYS_PTRACE
        # - SYS_PACCT
        - SYS_ADMIN
        # - SYS_BOOT
        # - SYS_NICE
        # - SYS_RESOURCE
        # - SYS_TIME
        # - SYS_TTY_CONFIG
        # - MKNOD
        # - LEASE
        # - AUDIT_WRITE
        # - AUDIT_CONTROL
        # - SETFCAP
        # - MAC_OVERRIDE
        # - MAC_ADMIN
        # - SYSLOG
        # - WAKE_ALARM
        # - BLOCK_SUSPEND
        # - AUDIT_READ
        # - PERFMON
        # - BPF
        # - CHECKPOINT_RESTORE
      privileged: true
      # allowPrivilegeEscalation: true
    tty: true
    volumeMounts:
    - mountPath: /dev/dri
      name: dev-dri
    - mountPath: /dev/input
      name: dev-input
    - mountPath: /dev/tty0
      name: dev-tty2
    - mountPath: /dev/tty2
      name: dev-tty2
    - mountPath: /dev/fuse
      name: dev-fuse
    - mountPath: /etc/nsswitch.conf
      name: nsswitch
    - mountPath: /etc/services
      name: services
    - mountPath: /dev/shm
      name: shm
    - mountPath: /mnt/home/oleg
      name: home-oleg
      readOnly: true
    - mountPath: /mnt/guix-workstation
      name: guix-workstation
    - mountPath: /mnt/nix
      name: nix
      readOnly: true
    lifecycle:
       preStop:
         exec:
           command:
           - halt
  volumes:
  - name: dev-dri
    hostPath:
      path: /dev/dri
      type: Directory
  - name: dev-input
    hostPath:
      path: /dev/input
      type: Directory
  - name: dev-tty2
    hostPath:
      path: /dev/tty2
      type: CharDevice
  - name: dev-fuse
    hostPath:
      path: /dev/fuse
      type: CharDevice
  - name: nsswitch
    hostPath:
      path: /etc/nsswitch.conf
      type: File
  - name: services
    hostPath:
      path: /etc/services
      type: File
  - name: shm
    emptyDir:
      medium: Memory
      sizeLimit: 1Gi
  - hostPath:
      path: /home/oleg
      type: Directory
    name: home-oleg
  - hostPath:
      path: /mnt/guix-workstation
      type: Directory
    name: guix-workstation
  - hostPath:
      path: /mnt/guix-workstation
      type: Directory
    name: guix-workstation
  - hostPath:
      path: /nix
      type: Directory
    name: nix
