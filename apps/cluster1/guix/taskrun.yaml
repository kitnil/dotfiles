apiVersion: tekton.dev/v1beta1
kind: TaskRun
metadata:
  name: execute-in-vm-with-ssh-taskrun-clean
spec:
  serviceAccountName: execute-in-vm-task
  taskRef:
    kind: ClusterTask
    name: execute-in-vm
  params:
  - name: vmName
    value: vm-guix-datavolume
  - name: secretName
    value: ssh-secret
  - name: script
    value: |
      #!/usr/bin/env bash
      set -o nounset -o errexit -o pipefail -o xtrace
      mkdir -p "${HOME}/.local/share"
      git clone https://gitlab.com/wigust/dotfiles "${HOME}/.local/share/chezmoi"
      cd "${HOME}/.local/share/chezmoi" || exit 1
      sudo -i guix system reconfigure "${PWD}/dotfiles/guixsd/vm-guix-datavolume.scm"
