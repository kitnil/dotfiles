apiVersion: tekton.dev/v1beta1
kind: TaskRun
metadata:
  name: execute-in-vm-with-ssh-taskrun-clean
spec:
  serviceAccountName: execute-in-vm-task
  taskRef:
    kind: ClusterTask
    name: execute-in-vm
  params:
  - name: vmName
    value: vm-guix-datavolume
  - name: secretName
    value: ssh-secret
  - name: script
    value: |
      #!/usr/bin/env bash
      set -o nounset -o errexit -o pipefail -o xtrace
      mkdir -p "${HOME}/.local/share"
      # TODO: Fix not available resolver provided by Kubernetes.
      echo "nameserver 192.168.0.145" | sudo tee /etc/resolv.conf
      guix install git
      if [[ -e "${HOME}/.local/share/chezmoi" ]]
      then
          :
      else
          git clone https://gitlab.com/wigust/dotfiles "${HOME}/.local/share/chezmoi"
      fi
      cd "${HOME}/.local/share/chezmoi" || exit 1
      guix pull --channels=dotfiles/channels-current-local-file.scm
      sudo -i guix system reconfigure "${PWD}/dotfiles/guixsd/vm-guix-datavolume.scm"
