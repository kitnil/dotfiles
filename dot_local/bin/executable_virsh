#!/run/current-system/profile/bin/bash

set -o errexit -o pipefail

VIRSH_DAEMON="${VIRSH_DAEMON:-false}"

gpu_reset()
{
    /home/oleg/.local/share/chezmoi/dot_local/bin/executable_gpu_reset.sh
}

case "$1" in
    start)
        case "$2" in
            kube1)
                if [[ -e /dev/lvm2/kube1 ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/kube1
                fi
                until [[ -e /var/run/libvirt/qemu/kube1.pid ]]
                do
                    if ((attempt > max_attempt))
                    then
                        exit 1
                    else
                        echo "vm-kube1: Start virtual machine." 1>&2
                        if /run/current-system/profile/bin/virsh start kube1
                        then
                            echo "vm-kube1: Started." 1>&2
                            break
                        else
                            echo "vm-kube1 [${attempt}/${max_attempt}]: Start kube1." 1>&2
                            /run/current-system/profile/bin/sleep 5
                            ((++attempt))
                        fi
                    fi
                done
                ;;
            cilium)
                if [[ -e /dev/lvm2/cilium ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/cilium
                fi
                exec /run/current-system/profile/bin/virsh start cilium
                ;;
            vm-cilium1)
                if [[ -e /dev/lvm2/vm-cilium1 ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/vm-cilium1
                fi
                exec /run/current-system/profile/bin/virsh start vm-cilium1
                ;;
            win*)
                domain="$2"
                if [[ $(/run/current-system/profile/bin/virsh domstate $domain) == running ]]
                then
                    echo "vm-${domain}: Virtual machine already running.  Sleeping infinity." 1>&2
                    if [[ $VIRSH_DAEMON == true ]]
                    then
                        exec /run/current-system/profile/bin/sleep infinity
                    fi
                    exec /run/current-system/profile/bin/sleep infinity
                fi
                if [[ -e /var/lib/vm-${domain}/3 ]]
                then
                    echo "vm-${domain}: 3rd attempt exist, exiting." 1>&2
                    exit 1
                fi
                /run/current-system/profile/bin/mkdir -p /var/lib/vm-${domain}
                for file in {1..3}
                do
                    if [[ -e /var/lib/vm-${domain}/${file} ]]
                    then
                        :
                    else
                        /run/current-system/profile/bin/touch /var/lib/vm-${domain}/${file}
                        break
                    fi
                done
                echo "vm-${domain}: Resetting GPU." 1>&2
                attempt=0
                max_attempt=15
                until [[ -S /var/run/libvirt/libvirt-sock ]]
                do
                    if ((attempt > max_attempt))
                    then
                        exit 1
                    else
                        echo "vm-${domain} [${attempt}/${max_attempt}]: Socket '/var/run/libvirt/libvirt-sock' does not exist. Sleeping 5 seconds." 1>&2
                        /run/current-system/profile/bin/sleep 5
                        ((++attempt))
                    fi
                done
                if [[ -e /var/lib/vm-${domain}/0 ]]
                then
                    echo "vm-${domain}: '/var/lib/vm-${domain}/0' file exist. Skipping GPU reset." 1>&2
                    :
                else
                    /run/current-system/profile/bin/touch /var/lib/vm-${domain}/0
                    gpu_reset
                fi
                if [[ -e /dev/lvm2/${domain} ]]
                then
                    echo "vm-${domain}: File '/dev/lvm2/${domain}' file exist." 1>&2
                else
                    /home/oleg/.guix-profile/sbin/lvchange -ay /dev/lvm2/${domain}
                fi
                # /sys/bus/pci/devices/0000:12:00.1/hdaudioC0D0
                # msi_irqs
                # sound
                if [[ -e /sys/bus/pci/devices/0000:12:00.1/msi_irqs ]]
                then
                    :
                else
                    echo "vm-${domain}: Missing '/sys/bus/pci/devices/0000:12:00.1/msi_irqs' file." 1>&2
                    exit 1
                fi
                attempt=0
                max_attempt=3
                until [[ -e /var/run/libvirt/qemu/${domain}.pid ]]
                do
                    if ((attempt > max_attempt))
                    then
                        exit 1
                    else
                        echo "vm-${domain}: Start virtual machine." 1>&2
                        if /run/current-system/profile/bin/virsh start "$domain"
                        then
                            echo "vm-${domain}: Started." 1>&2
                            break
                        else
                            echo "vm-${domain} [${attempt}/${max_attempt}]: Start ${domain}." 1>&2
                            /run/current-system/profile/bin/sleep 5
                            ((++attempt))
                        fi
                    fi
                done
                if [[ $VIRSH_DAEMON == true ]]
                then
                    echo "vm-${domain}: Started. Sleeping infinity." 1>&2
                    # trap clean EXIT
                    # # [ShellCheck: SC2317 â€“ Command appears to be unreachable. Check usage (or ignore if invoked indirectly).]
                    # # (https://www.shellcheck.net/wiki/SC2317)
                    # #
                    # # > ### Exceptions:
                    # # >
                    # # > ShellCheck may incorrectly believe that code is unreachable if
                    # # > it's invoked by variable name or in a trap. In such a case, please
                    # # > [Ignore](https://www.shellcheck.net/wiki/Ignore) the message.
                    # #
                    # # shellcheck disable=SC2317 # Don't warn about unreachable commands in this function
                    # clean()
                    # {
                    #     if [[ $(/run/current-system/profile/bin/virsh domstate "$domain") == "shut off" ]]
                    #     then
                    #         echo "vm-${domain}: Resetting GPU on trap clean." 1>&2
                    #         gpu_reset
                    #     fi
                    # }
                    # /run/current-system/profile/bin/sleep infinity
                    /run/current-system/profile/bin/sleep infinity
                fi
                ;;
            *)
                exec /run/current-system/profile/bin/virsh start "${@:3}"
                ;;
        esac
        ;;
    *)
        exec /run/current-system/profile/bin/virsh "${@:1}"
esac
