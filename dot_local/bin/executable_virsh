#!/usr/bin/env bash

set -o errexit -o pipefail

case "$1" in
    start)
        case "$2" in
            kube1)
                if [[ -e /dev/lvm2/kube1 ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/kube1
                fi
                exec /run/current-system/profile/bin/virsh start kube1
                ;;
            cilium)
                if [[ -e /dev/lvm2/cilium ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/cilium
                fi
                exec /run/current-system/profile/bin/virsh start cilium
                ;;
            vm-cilium1)
                if [[ -e /dev/lvm2/vm-cilium1 ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/vm-cilium1
                fi
                exec /run/current-system/profile/bin/virsh start vm-cilium1
                ;;
            win10)
                echo "virsh: Resetting GPU." 1>&2
                if [[ -e /sys/kernel/debug/dri/0/amdgpu_gpu_recover ]]
                then
                    cat /sys/kernel/debug/dri/0/amdgpu_gpu_recover
                elif [[ -e /sys/kernel/debug/dri/2/amdgpu_gpu_recover ]]
                then
                    cat /sys/kernel/debug/dri/2/amdgpu_gpu_recover
                fi
                exec /run/current-system/profile/bin/virsh start win10
                ;;
            *)
                exec /run/current-system/profile/bin/virsh start "${@:3}"
                ;;
        esac
        ;;
    *)
        exec /run/current-system/profile/bin/virsh "${@:1}"
esac
