#!/run/current-system/profile/bin/bash

set -o errexit -o pipefail

VIRSH_DAEMON="${VIRSH_DAEMON:-false}"

exec &> >(/run/current-system/profile/bin/tee /var/log/virsh-vm-win2022.log)

case "$1" in
    start)
        case "$2" in
            kube1)
                if [[ -e /dev/lvm2/kube1 ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/kube1
                fi
                exec /run/current-system/profile/bin/virsh start kube1
                ;;
            cilium)
                if [[ -e /dev/lvm2/cilium ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/cilium
                fi
                exec /run/current-system/profile/bin/virsh start cilium
                ;;
            vm-cilium1)
                if [[ -e /dev/lvm2/vm-cilium1 ]]
                then
                    :
                else
                    lvchange -ay /dev/lvm2/vm-cilium1
                fi
                exec /run/current-system/profile/bin/virsh start vm-cilium1
                ;;
            win2022)
                if [[ $(/run/current-system/profile/bin/virsh domstate win2022) == running ]]
                then
                    echo "vm-win2022: Virtual machine already running.  Sleeping infinity." 1>&2
                    if [[ $VIRSH_DAEMON == true ]]
                    then
                        exec /run/current-system/profile/bin/sleep infinity
                    fi
                    exec /run/current-system/profile/bin/sleep infinity
                fi
                if [[ -e /var/lib/vm-win2022/3 ]]
                then
                    echo "vm-win2022: 3rd attempt exist, exiting." 1>&2
                    exit 1
                fi
                /run/current-system/profile/bin/mkdir -p /var/lib/vm-win2022
                for file in {1..3}
                do
                    if [[ -e /var/lib/vm-win2022/${file} ]]
                    then
                        :
                    else
                        /run/current-system/profile/bin/touch /var/lib/vm-win2022/${file}
                        break
                    fi
                done
                echo "vm-win2022: Resetting GPU." 1>&2
                attempt=0
                max_attempt=15
                until [[ -S /var/run/libvirt/libvirt-sock ]]
                do
                    if ((attempt > max_attempt))
                    then
                        exit 1
                    else
                        echo "vm-win2022 [${attempt}/${max_attempt}]: Socket '/var/run/libvirt/libvirt-sock' does not exist. Sleeping 5 seconds." 1>&2
                        /run/current-system/profile/bin/sleep 5
                        ((++attempt))
                    fi
                done
                if [[ -e /var/lib/vm-win2022/0 ]]
                then
                    echo "vm-win2022: '/var/lib/vm-win2022/0' file exist. Skipping GPU reset." 1>&2
                    :
                else
                    /run/current-system/profile/bin/touch /var/lib/vm-win2022/0
                    if [[ -e /sys/kernel/debug/dri/0/amdgpu_gpu_recover ]]
                    then
                        if [[ -e /sys/bus/pci/devices/0000:12:00.1/remove ]]
                        then
                            echo 1 > /sys/bus/pci/devices/0000:12:00.1/remove
                            /run/current-system/profile/bin/cat /sys/kernel/debug/dri/0/amdgpu_gpu_recover
                            echo 1 > /sys/bus/pci/rescan
                        fi
                        /run/current-system/profile/bin/cat /sys/kernel/debug/dri/0/amdgpu_gpu_recover
                    elif [[ -e /sys/kernel/debug/dri/2/amdgpu_gpu_recover ]]
                    then
                        if [[ -e /sys/bus/pci/devices/0000:12:00.1/remove ]]
                        then
                            echo 1 > /sys/bus/pci/devices/0000:12:00.1/remove
                            /run/current-system/profile/bin/cat /sys/kernel/debug/dri/2/amdgpu_gpu_recover
                            echo 1 > /sys/bus/pci/rescan
                        fi
                        /run/current-system/profile/bin/cat /sys/kernel/debug/dri/2/amdgpu_gpu_recover
                    fi
                fi
                if [[ -e /dev/lvm2/win2022 ]]
                then
                    echo "vm-win2022: File '/dev/lvm2/win2022' file exist." 1>&2
                else
                    /home/oleg/.guix-profile/sbin/lvchange -ay /dev/lvm2/win2022
                fi
                attempt=0
                max_attempt=3
                until [[ -e /var/run/libvirt/qemu/win2022.pid ]]
                do
                    if ((attempt > max_attempt))
                    then
                        exit 1
                    else
                        echo "vm-win2022: Start virtual machine." 1>&2
                        if /run/current-system/profile/bin/virsh start win2022
                        then
                            echo "vm-win2022: Started." 1>&2
                            break
                        else
                            echo "vm-win2022 [${attempt}/${max_attempt}]: Start win2022." 1>&2
                            /run/current-system/profile/bin/sleep 5
                            ((++attempt))
                        fi
                    fi
                done
                if [[ $VIRSH_DAEMON == true ]]
                then
                    echo "vm-win2022: Started. Sleeping infinity." 1>&2
                    exec /run/current-system/profile/bin/sleep infinity
                fi
                ;;
            *)
                exec /run/current-system/profile/bin/virsh start "${@:3}"
                ;;
        esac
        ;;
    *)
        exec /run/current-system/profile/bin/virsh "${@:1}"
esac
