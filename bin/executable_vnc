#!/usr/bin/env bash

set -e
set -o pipefail

help_main()
{
    echo "\
Usage: vnc COMMANDS ARGS...
Run COMMANDS with ARGS

COMMAND must be one of the sub-commands listed below:

   mjru
   vm
   server

Report bugs to: go.wigust@gmail.com."
}

help_server()
{
    echo "\
Usage: vnc server [OPTION] PORT...
Run vnc server at PORT.

  -h, --help             display this help and exit

Report bugs to: go.wigust@gmail.com."
}

case "$1" in
    --help)
        help_main
        ;;
    client)
        case "$2" in
            mjru)
                ssh majordomo.intr -- "pgrep -fa 'Xvnc :3'" \
                    || ssh majordomo.intr -- 'vncserver -xstartup "$HOME/.vnc/xstartup" :3'
                ss -o state listening '( dport = 59588 or sport = 59588 )' | grep -q :59588 \
                    || ssh -fNL 59588:localhost:5903 majordomo.intr
                vncviewer -PasswordFile ~/.vnc/passwd -NoJpeg localhost:59588
                ;;
            vm)
                ss -o state listening '( dport = 5911 or sport = 5911 )' | grep -q :5911 \
                    || ssh -fNL 5911:localhost:5901 guix.vm.wugi.info
                vncviewer -AutoSelect=0 -PreferredEncoding=Raw -FullColor=1 -NoJPEG=1 -CompressLevel=0 -passwd ~/.vnc/passwd 127.0.0.1:5911
                ;;
            novnc)
                docker run --detach --name novnc --network=host geek1011/easy-novnc:latest --addr 127.0.0.1:5911 --port 5910 --novnc-params "resize=remote"
                ;;
            *)
                vncviewer -AutoSelect=0 -PreferredEncoding=Raw -FullColor=1 -NoJPEG=1 -CompressLevel=0 -passwd "$HOME/.vnc/passwd" 127.0.0.1:"$2"
                ;;
        esac
        ;;
    server)
        case "$2" in
            --help)
                help_server
                ;;
            5901|firefox)
                vncserver -xstartup "$HOME/.vnc/xstartup-firefox" :1
                ;;
            5902|workstation)
                vncserver -geometry 1920x1080 -xstartup "$HOME/.vnc/xstartup-stumpwm" :2
                ;;
            5903|small)
                vncserver -geometry 1366x768 -xstartup "$HOME/.vnc/xstartup-stumpwm" :3
                ;;
            5910|quassel)
                vncserver -xstartup "$HOME/.vnc/xstartup-quassel" :10
                ;;
            *)
                help_server
                ;;
        esac
        ;;
    *)
        help_main
        ;;
esac
