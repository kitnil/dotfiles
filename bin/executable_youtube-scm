#!/usr/bin/env -S guile --no-auto-compile -e (youtube-scm) -s
!#

;;;; youtube-scm --- SYNOPSIS
;;;; Copyright Â© 2020 Oleg Pykhalov <go.wigust@gmail.com>
;;;; Released under the GNU GPLv3 or any later version.

(define-module (youtube-scm)
  #:use-module (srfi srfi-37)
  #:use-module (ice-9 popen)
  #:use-module (ice-9 rdelim)
  #:use-module (ice-9 pretty-print)
  #:use-module (srfi srfi-1)
  #:export (main))

;;; Commentary:
;;;
;;; DESCRIPTION
;;;
;;; Code:

(define %options
  (let ((display-and-exit-proc (lambda (msg)
                                 (lambda (opt name arg loads)
                                   (display msg) (quit)))))
    (list (option '(#\u "url") #t #f
                  (lambda (opt name arg result)
                    (alist-cons 'url arg result)))
          (option '(#\m "home-page") #t #f
                  (lambda (opt name arg result)
                    (alist-cons 'home-page arg result)))
          (option '(#\v "version") #f #f
                  (display-and-exit-proc "youtube-scm version 0.0.1\n"))
          (option '(#\h "help") #f #f
                  (display-and-exit-proc
                   "Usage: youtube-scm ...")))))

(define %default-options
  '())

(define (main args)
  (define opts
    (args-fold (cdr (program-arguments))
               %options
               (lambda (opt name arg loads)
                 (error "Unrecognized option `~A'" name))
               (lambda (op loads)
                 (cons op loads))
               %default-options))
  (let* ((url (assoc-ref opts 'url))
         (home-page (assoc-ref opts 'home-page))
         (port (open-pipe (format #f "youtube-dl --ignore-errors --dump-single-json ~s | jq --raw-output .title"
                                  url)
                          OPEN_READ))
         (output (string-trim-right (read-string port))))
    (close-pipe port)
    (pretty-print `(package (name ,output)
                            (source (origin (method url-fetch)
                                            (uri ,url)))
                            (build-system trivial-build-system)
                            (home-page ,(or home-page ""))
                            (synopsis "")
                            (description "")
                            (license #f))
                  #:max-expr-width 79)))

;;; youtube-scm ends here
