user nginx-with-lua nginx-with-lua;
pid /var/run/nginx-with-lua/pid;
error_log /var/log/nginx-with-lua/error.log info;
events { }
http {
    client_body_temp_path /var/run/nginx-with-lua/client_body_temp;
    proxy_temp_path /var/run/nginx-with-lua/proxy_temp;
    fastcgi_temp_path /var/run/nginx-with-lua/fastcgi_temp;
    uwsgi_temp_path /var/run/nginx-with-lua/uwsgi_temp;
    scgi_temp_path /var/run/nginx-with-lua/scgi_temp;
    access_log /var/log/nginx-with-lua/access.log;
    types {
        text/html html htm shtml;
        text/css css;
        text/xml xml;
        image/gif gif;
        image/jpeg jpeg jpg;
        application/javascript js;
        application/atom+xml atom;
        application/rss+xml rss;
        text/mathml mml;
        text/plain txt;
        text/vnd.sun.j2me.app-descriptor jad;
        text/vnd.wap.wml wml;
        text/x-component htc;
    }
    server {
        listen 8088;
        server_name localhost;
        root /var/run/nginx-with-lua;
        index index.html ;
        server_tokens off;
        location /guix/describe {
            default_type 'text/plain';
            content_by_lua '
            local shell = require "resty.shell"
            local stdin = ""
            local timeout = 1000  -- ms
            local max_size = 4096  -- byte
            local ok, stdout, stderr, reason, status = shell.run([[/run/current-system/profile/bin/guix describe --format=json]], stdin, timeout, max_size)
            ngx.say(stdout)
            ';
        }
    }
}
