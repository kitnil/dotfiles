build:
  tags:
    - remote
  script:
    - ./build.sh
  only:
    changes:
      - ".gitlab-ci.yml"
      - "build.sh"
      - "*.scm"
      - "**/*.scm"
  except:
    - schedules

shedule:
  tags:
    - remote
  script:
    - git config user.email gitlab-runner@wugi.info
    - "git config user.name 'GitLab Runner'"
    - "git merge --strategy-option=ours -m \"Merge branch 'shedule-channels'\" origin/shedule-channels"
    - git remote set-url --push origin $(printf $CI_REPOSITORY_URL | perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#')
    - ./guile/guix-channels-update && cat ./channels.scm
    - git add channels.scm
    - "git commit -m 'channels.scm: Update channels.scm.'"
    - git push origin HEAD:shedule-channels || true
  only:
    - schedules
