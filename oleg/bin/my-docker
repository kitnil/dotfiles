#!/bin/sh

docker run \
       --name influxdb \
       --detach \
       --restart unless-stopped \
       --env 'INFLUXDB_ADMIN_ENABLED=true' \
       --publish 8083:8083 \
       --publish 8086:8086 \
       --volume /var/lib/influxdb:/var/lib/influxdb \
       --volume /etc/influxdb/influxdb.conf:/etc/influxdb/influxdb.conf:ro \
       influxdb -config /etc/influxdb/influxdb.conf

docker run \
       --name telegraf \
       --detach \
       --restart unless-stopped \
       --net=container:influxdb \
       --env HOST_PROC=/host/proc \
       --volume /proc:/host/proc:ro \
       --volume /etc/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro \
       telegraf

docker run \
       --name grafana \
       --detach \
       --restart unless-stopped \
       --user 30020:0 \
       --publish 3080:3000 \
       --volume /var/lib/grafana:/var/lib/grafana \
       --mount type=bind,source=/etc/localtime,target=/etc/localtime,readonly \
       -e "GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,alexanderzobnin-zabbix-app" \
       grafana/grafana

docker run \
       --name elasticsearch \
       --detach \
       --restart unless-stopped \
       --volume /var/lib/elasticsearch/data:/usr/share/elasticsearch/data \
       --volume /srv/elk/backup:/mnt/backup \
       --volume /etc/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
       --publish 9200:9200 \
       --publish 9300:9300 \
       docker.elastic.co/elasticsearch/elasticsearch:6.5.1

docker run \
       --name filebeat \
       --detach \
       --add-host elasticsearch:192.168.105.120 \
       --restart unless-stopped \
       --mount type=bind,source=/etc/filebeat/filebeat.yml,target=/usr/share/filebeat/filebeat.yml \
       --mount type=bind,source=/var/log,target=/mnt/log,readonly \
       --mount type=bind,source=/etc/localtime,target=/etc/localtime,readonly \
       --hostname guixsd \
       docker.elastic.co/beats/filebeat:6.5.1 -e -strict.perms=false -E output.elasticsearch.hosts=["elasticsearch:9200"] -E name="guixsd"

docker run \
       --name kibana \
       --detach \
       --restart unless-stopped \
       --publish 5601:5601 \
       --mount type=bind,source=/etc/kibana/kibana.yml,target=/usr/share/kibana/config/kibana.yml \
       docker.elastic.co/kibana/kibana:6.5.1

docker run \
       --restart unless-stopped \
       --hostname gitlab \
       --add-host gitlab.wugi.info:127.0.0.1 \
       --add-host smtp:172.17.0.1 \
       --name gitlab \
       --detach \
       --publish 65080:80 \
       --publish 65022:22 \
       --publish 65090:9090 \
       --volume /etc/gitlab:/etc/gitlab \
       --volume /var/log/gitlab:/var/log/gitlab \
       --volume /var/lib/gitlab:/var/opt/gitlab \
       gitlab/gitlab-ce:11.6.0-ce.0

docker run \
       --name jenkins \
       --hostname jenkins \
       --detach \
       --restart unless-stopped \
       --add-host gitlab.wugi.info:192.168.105.120 \
       --user 30018:30004 \
       --volume /home/jenkins:/var/jenkins_home \
       --publish 30080:8080 \
       --publish 50000:50000 \
       jenkins/jenkins:lts

docker run \
       --name registry \
       --hostname registry \
       --detach \
       --restart unless-stopped \
       --publish 5000:5000 \
       --volume /var/lib/docker-registry:/var/lib/registry \
       registry:2

docker run \
       --name malscan \
       --detach \
       --interactive \
       --publish 48080:8080 \
       --volume /home/oleg/src/malscan:/var/www \
       localhost:5000/malscannew

docker run \
       --name malscan-db \
       --detach \
       --interactive \
       --publish 48306:3306 \
       localhost:5000/ubuntu
